{% extends 'base.html.twig' %}

{% block title %}Tous les Livres - Bookly{% endblock %}

{% block body %}
<section id="page-header" class="padding-large" style="background-image: url('{{ asset('images/banner-image-bg.jpg') }}'); background-size: cover; background-repeat: no-repeat; background-position: center; height: 300px; display: flex; align-items: center;">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h1 class="display-4 text-white">üìö Tous les Livres</h1>
        <p class="lead text-white">Parcourez notre collection compl√®te de livres</p>
      </div>
    </div>
  </div>
</section>

<section class="padding-large">
  <div class="container">
    <!-- Filter Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üîç Filtrer et Rechercher des Livres</h5>
            <div class="row">
              <div class="col-md-3">
                <select class="form-select" id="categoryFilter">
                  <option value="">Toutes les Cat√©gories</option>
                  {% for categorie in categories %}
                  <option value="{{ categorie.id }}">{{ categorie.nom }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <input type="text" class="form-control" id="searchFilter" placeholder="Rechercher des livres par titre...">
              </div>
              <div class="col-md-3">
                <select class="form-select" id="stockFilter">
                  <option value="">Tous les Statuts de Stock</option>
                  <option value="in-stock">En Stock</option>
                  <option value="low-stock">Stock Faible</option>
                  <option value="out-of-stock">√âpuis√©</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="sortFilter">
                  <option value="title">Trier par Titre</option>
                  <option value="price-low">Prix : Croissant</option>
                  <option value="price-high">Prix : D√©croissant</option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <button class="btn btn-primary" onclick="applyFilters()">Appliquer les Filtres</button>
                <button class="btn btn-secondary ms-2" onclick="clearFilters()">Effacer les Filtres</button>
              </div>
              <div class="col-md-6 text-end">
                <span id="resultsCount" class="text-muted">{{ livres|length }} livres trouv√©s</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Books Grid -->
    <div class="row" id="booksContainer">
      {% for livre in livres %}
      <div class="col-md-3 mb-4 book-item"
           data-category="{{ livre.categorie ? livre.categorie.id : '' }}"
           data-title="{{ livre.titre|lower }}"
           data-price="{{ livre.prixUnitaire }}"
           data-stock="{{ livre.qte }}">
        <div class="card h-100 position-relative book-card">
          {% if livre.prixUnitaire > 100 %}
          <div class="position-absolute top-0 start-0 bg-primary text-white px-2 py-1 rounded" style="top: 10px; left: 10px; font-size: 0.8rem; z-index: 10;">10% de r√©duction</div>
          {% endif %}

          <!-- Stock Status Badge -->
          {% if livre.qte > 10 %}
            <div class="position-absolute top-0 end-0 bg-success text-white px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">En Stock</div>
          {% elseif livre.qte > 0 %}
            <div class="position-absolute top-0 end-0 bg-warning text-dark px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">Stock Faible</div>
          {% else %}
            <div class="position-absolute top-0 end-0 bg-danger text-white px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">√âpuis√©</div>
          {% endif %}

          <img src="{% if livre.pdfFilename %}{{ asset('uploads/images/' ~ livre.pdfFilename) }}{% else %}{{ asset('images/product-item' ~ (loop.index % 12 + 1) ~ '.png') }}{% endif %}" class="card-img-top" alt="{{ livre.titre }}">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title">{{ livre.titre }}</h6>
            <p class="card-text text-muted small">{{ livre.auteurs ? livre.auteurs|join(', ') : 'Auteur Inconnu' }}</p>

            <!-- Rating -->
            <div class="rating text-warning mb-2">
              <svg class="star star-fill" width="14" height="14">
                <use xlink:href="#star-fill"></use>
              </svg>
              <svg class="star star-fill" width="14" height="14">
                <use xlink:href="#star-fill"></use>
              </svg>
              <svg class="star star-fill" width="14" height="14">
                <use xlink:href="#star-fill"></use>
              </svg>
              <svg class="star star-fill" width="14" height="14">
                <use xlink:href="#star-fill"></use>
              </svg>
              <svg class="star star-fill" width="14" height="14">
                <use xlink:href="#star-fill"></use>
              </svg>
            </div>

            <!-- Price -->
            <p class="card-text fw-bold text-primary mb-3">{{ livre.prixUnitaire }} DT</p>

            <!-- Action Buttons -->
            <div class="mt-auto">
              <div class="d-flex gap-2 mb-2">
                {% if livre.qte > 0 %}
                <form action="{{ path('app_cart_add', {'id': livre.id}) }}" method="post" class="flex-fill">
                  <button type="submit" class="btn btn-primary btn-sm w-100" title="Ajouter au Panier">
                    <svg class="cart me-1" width="14" height="14">
                      <use xlink:href="#cart"></use>
                    </svg>
                    Ajouter au Panier
                  </button>
                </form>
                {% else %}
                <button class="btn btn-secondary btn-sm w-100" disabled>√âpuis√©</button>
                {% endif %}
              </div>

              <div class="d-flex gap-2">
                <a href="{{ path('app_wishlist_add', {'id': livre.id}) }}" class="btn btn-outline-danger btn-sm flex-fill" title="Ajouter √† la Liste d'Envies">
                  <svg class="wishlist me-1" width="14" height="14">
                    <use xlink:href="#heart"></use>
                  </svg>
                  Liste d'Envies
                </a>
                <a href="{{ path('app_livre_show', {'id': livre.id}) }}" class="btn btn-outline-info btn-sm" title="Voir les D√©tails">
                  <i class="fas fa-eye"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
function applyFilters() {
  const categoryFilter = document.getElementById('categoryFilter').value;
  const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
  const stockFilter = document.getElementById('stockFilter').value;
  const sortFilter = document.getElementById('sortFilter').value;
  const books = document.querySelectorAll('.book-item');
  let visibleCount = 0;

  books.forEach(book => {
    const category = book.dataset.category;
    const title = book.dataset.title;
    const stock = parseInt(book.dataset.stock);
    const price = parseFloat(book.dataset.price);

    let show = true;

    // Category filter
    if (categoryFilter && category !== categoryFilter) {
      show = false;
    }

    // Search filter
    if (searchFilter && !title.includes(searchFilter)) {
      show = false;
    }

    // Stock filter
    if (stockFilter) {
      if (stockFilter === 'in-stock' && stock <= 0) {
        show = false;
      } else if (stockFilter === 'low-stock' && (stock <= 0 || stock > 5)) {
        show = false;
      } else if (stockFilter === 'out-of-stock' && stock > 0) {
        show = false;
      }
    }

    if (show) {
      book.style.display = 'block';
      visibleCount++;
    } else {
      book.style.display = 'none';
    }
  });

  // Update results count
  document.getElementById('resultsCount').textContent = visibleCount + ' livres trouv√©s';

  // Sorting (basic implementation)
  if (sortFilter) {
    const container = document.getElementById('booksContainer');
    const booksArray = Array.from(books);

    booksArray.sort((a, b) => {
      if (sortFilter === 'title') {
        return a.dataset.title.localeCompare(b.dataset.title);
      } else if (sortFilter === 'price-low') {
        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
      } else if (sortFilter === 'price-high') {
        return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
      }
      return 0;
    });

    // Reorder DOM elements
    booksArray.forEach(book => {
      if (book.style.display !== 'none') {
        container.appendChild(book);
      }
    });
  }
}

function clearFilters() {
  document.getElementById('categoryFilter').value = '';
  document.getElementById('searchFilter').value = '';
  document.getElementById('stockFilter').value = '';
  document.getElementById('sortFilter').value = 'title';

  const books = document.querySelectorAll('.book-item');
  books.forEach(book => {
    book.style.display = 'block';
  });

  document.getElementById('resultsCount').textContent = books.length + ' livres trouv√©s';
}

// Real-time search
document.getElementById('searchFilter').addEventListener('input', function() {
  applyFilters();
});
</script>

<style>
.book-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.book-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.rating svg {
  margin-right: 2px;
}

.btn-sm {
  font-size: 0.8rem;
  padding: 0.4rem 0.8rem;
}
</style>
{% endblock %}
