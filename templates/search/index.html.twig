{% extends 'base.html.twig' %}

{% block title %}Résultats de recherche - {{ query }}{% endblock %}

{% block body %}
<section class="padding-large">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="mb-4">
          <form role="search" method="get" class="d-flex justify-content-center" action="{{ path('app_search') }}">
            <input type="search" name="s" class="form-control me-2" placeholder="Rechercher des livres..." value="{{ query }}" style="max-width: 400px;">
            <button type="submit" class="btn btn-primary">Rechercher</button>
          </form>
        </div>
        {% if query %}
        <h2 class="mb-4">Résultats de recherche pour "{{ query }}"</h2>
        {% endif %}

        {% if query and livres is empty %}
          <div class="alert alert-info">
            Aucun livre trouvé pour "{{ query }}". Essayez une autre recherche.
          </div>
        {% elseif not query %}
          <div class="alert alert-info">
            Entrez un terme de recherche pour trouver des livres.
          </div>
        {% else %}
          <p class="text-muted mb-4">{{ livres|length }} livre{{ livres|length > 1 ? 's' : '' }} trouvé{{ livres|length > 1 ? 's' : '' }}</p>

          <div class="row">
            {% for livre in livres %}
            <div class="col-md-4 mb-4">
              <div class="card h-100 position-relative book-card">
                {% if livre.prixUnitaire > 100 %}
                <div class="position-absolute top-0 start-0 bg-primary text-white px-2 py-1 rounded" style="top: 10px; left: 10px; font-size: 0.8rem; z-index: 10;">10% de réduction</div>
                {% endif %}

                <!-- Stock Status Badge -->
                {% if livre.qte > 10 %}
                  <div class="position-absolute top-0 end-0 bg-success text-white px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">En Stock</div>
                {% elseif livre.qte > 0 %}
                  <div class="position-absolute top-0 end-0 bg-warning text-dark px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">Stock Faible</div>
                {% else %}
                  <div class="position-absolute top-0 end-0 bg-danger text-white px-2 py-1 rounded" style="top: 10px; right: 10px; font-size: 0.7rem; z-index: 10;">Épuisé</div>
                {% endif %}

                <img src="{% if livre.pdfFilename %}{{ asset('uploads/images/' ~ livre.pdfFilename) }}{% else %}{{ asset('images/product-item' ~ (loop.index % 12 + 1) ~ '.png') }}{% endif %}" class="card-img-top" alt="{{ livre.titre }}">
                <div class="card-body d-flex flex-column">
                  <h6 class="card-title">{{ livre.titre }}</h6>
                  <p class="card-text text-muted small">{{ livre.auteurs ? livre.auteurs|join(', ') : 'Auteur Inconnu' }}</p>

                  <!-- Rating -->
                  <div class="rating text-warning mb-2">
                    <svg class="star star-fill" width="14" height="14">
                      <use xlink:href="#star-fill"></use>
                    </svg>
                    <svg class="star star-fill" width="14" height="14">
                      <use xlink:href="#star-fill"></use>
                    </svg>
                    <svg class="star star-fill" width="14" height="14">
                      <use xlink:href="#star-fill"></use>
                    </svg>
                    <svg class="star star-fill" width="14" height="14">
                      <use xlink:href="#star-fill"></use>
                    </svg>
                    <svg class="star star-fill" width="14" height="14">
                      <use xlink:href="#star-fill"></use>
                    </svg>
                  </div>

                  <!-- Price -->
                  <p class="card-text fw-bold text-primary mb-3">{{ livre.prixUnitaire }} DT</p>

                  <!-- Action Buttons -->
                  <div class="mt-auto">
                    <div class="d-flex gap-2 mb-2">
                      {% if livre.qte > 0 %}
                      <form action="{{ path('app_cart_add', {'id': livre.id}) }}" method="post" class="flex-fill">
                        <button type="submit" class="btn btn-primary btn-sm w-100" title="Ajouter au Panier">
                          <svg class="cart me-1" width="14" height="14">
                            <use xlink:href="#cart"></use>
                          </svg>
                          Ajouter au Panier
                        </button>
                      </form>
                      {% else %}
                      <button class="btn btn-secondary btn-sm w-100" disabled>Épuisé</button>
                      {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                      <a href="{{ path('app_wishlist_add', {'id': livre.id}) }}" class="btn btn-outline-danger btn-sm flex-fill" title="Ajouter à la Liste d'Envies">
                        <svg class="wishlist me-1" width="14" height="14">
                          <use xlink:href="#heart"></use>
                        </svg>
                        Liste d'Envies
                      </a>
                      <a href="{{ path('app_livre_show', {'id': livre.id}) }}" class="btn btn-outline-info btn-sm" title="Voir les Détails">
                        <i class="fas fa-eye"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="mt-4">
          <a href="{{ path('app_home') }}" class="btn btn-secondary">Retour à l'accueil</a>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}